<xrx:widget xmlns:xrx="http://www.monasterium.net/NS/xrx"
	xmlns="http://www.w3.org/1999/xhtml">
  <xrx:id>tag:www.monasterium.net,2011:/mom/widget/how-to-cite</xrx:id>
  <xrx:title>
	  <xrx:i18n>
	    <xrx:key>how-to-cite</xrx:key>
	    <xrx:default>How-to-cite</xrx:default>
	  </xrx:i18n>
  </xrx:title>
  <xrx:subtitle></xrx:subtitle>
  <xrx:description></xrx:description>
  <xrx:author>niklas.tscherne@uni-graz.at</xrx:author>
  <xrx:licence>
This is a component file of the VdU Software for a Virtual Research Environment for the handling of Medieval charters.

As the source code is available here, it is somewhere between an alpha- and a beta-release, may be changed without any consideration of backward compatibility of other parts of the system, therefore, without any notice.

This file is part of the VdU Virtual Research Environment Toolkit (VdU/VRET).

The VdU/VRET is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

VdU/VRET is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with VdU/VRET.  If not, see http://www.gnu.org/licenses.
  </xrx:licence>
  <xrx:variables>
    <!-- charter context: collection or fond? -->
    <xrx:variable>
      <xrx:name>$wcharter:context</xrx:name>
      <xrx:expression>if(count($xrx:tokenized-uri) = 2) then 'linked-fond' else if(count($xrx:tokenized-uri) = 3) then 'collection' else 'fond'</xrx:expression>
    </xrx:variable>
    <!-- atom ID -->
    <xrx:variable>
      <xrx:name>$wcharter:atom-id</xrx:name>
      <xrx:expression>
        if($wcharter:context = 'fond') then
          metadata:atomid('charter', ($charter:rarchiveid, $charter:rfondid, $charter:rcharterid))
        else if(($wcharter:context = 'collection')or ($wcharter:context = 'mycollection'))then
          metadata:atomid('charter', ($charter:rcollectionid, $charter:rcharterid))
        else request:get-parameter('atomid', '')
      </xrx:expression>
    </xrx:variable>
    <!-- default url -->
    <xrx:variable>
      <xrx:name>$wcharter:default-url</xrx:name>
      <xrx:expression>
        concat(conf:param('request-root'), substring-after($wcharter:atom-id, 'charter/'))
      </xrx:expression>
    </xrx:variable>
    <!-- init metadata database collections -->
    <xrx:variable>
      <xrx:name>$wcharter:metadata-fond-collection</xrx:name>
      <xrx:expression>
        if($wcharter:context != 'linked-fond') then
          metadata:base-collection('fond', ($charter:rarchiveid, $charter:rfondid), 'public')
        else
          metadata:base-collection('fond', (charter:archid($wcharter:atom-id, conf:param('atom-tag-name')), charter:fondid($wcharter:atom-id, conf:param('atom-tag-name'))), 'public')
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:metadata-archive-collection</xrx:name>
      <xrx:expression>
        if($wcharter:context != 'linked-fond') then
          metadata:base-collection('archive', $charter:rarchiveid, 'public')
        else
          metadata:base-collection('archive', charter:archid($wcharter:atom-id, conf:param('atom-tag-name')), 'public')
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:metadata-collection-collection</xrx:name>
      <xrx:expression>(metadata:base-collection('collection', $charter:rcollectionid, 'public')|metadata:base-collection('mycollection', $charter:rcollectionid, 'public'))</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:linked-fond-charter-collection</xrx:name>
      <xrx:expression>mycollection:linked-fond-charter-base-collection($wcharter:metadata-collection-collection)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:metadata-charter-collection</xrx:name>
      <xrx:expression>
        if($wcharter:context = 'fond') then
          metadata:base-collection('charter', ($charter:rarchiveid, $charter:rfondid), 'public')
        else if(($wcharter:context = 'collection')or ($wcharter:context = 'mycollection')) then
          metadata:base-collection('charter', $charter:rcollectionid, 'public')
        else 
          $wcharter:linked-fond-charter-collection
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:cei-text-element-of-current-charter</xrx:name>
      <xrx:expression>root($wcharter:metadata-charter-collection//atom:id[.=$wcharter:atom-id])//cei:text</xrx:expression>
    </xrx:variable>
    <!-- There was suboptimal code to begin with, here. The $wcharter:charter became an empty sequence, when the ft:query returned nothing before
         (as is the behaviour with hits in attributes, because full-text-search of cei:text only searches the string-representation of cei:text, i.e. no attributes-values inside tags).
         The application-logic depends on the $wcharter:charter to not be empty, because all sorts of calculations depend on it. The ft:query function should
         only be called, after all the application-logic is done, I guess. The only effect it presumably has is for the KWIC to kick in. This leads to the search-term hit being
         highlighted later on (kwic:summarize). -->
    <xrx:variable>
      <xrx:name>$wcharter:charter</xrx:name>
      <xrx:expression>
        if($search:q = '') then $wcharter:cei-text-element-of-current-charter
        else
          let $query-result := ft:query($wcharter:cei-text-element-of-current-charter, $search:q, $search:options)
          return
            if (not(empty($query-result))) then $query-result
            else $wcharter:cei-text-element-of-current-charter
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:just-linked-atomid</xrx:name>
      <xrx:expression>root($wcharter:charter)//atom:content/@src/string()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:linked-atomid</xrx:name>
      <xrx:expression>root($wcharter:charter)//atom:link[@rel='versionOf'][1]/@ref/string()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:just-linked</xrx:name>
      <xrx:expression>$wcharter:just-linked-atomid != ''</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:linked</xrx:name>
      <xrx:expression>$wcharter:linked-atomid != ''</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:public-charter</xrx:name>
      <xrx:expression>if($wcharter:linked or $wcharter:just-linked) then charter:public-entry($wcharter:linked-atomid)//cei:text else()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:charter</xrx:name>
      <xrx:expression>if($wcharter:just-linked) then $wcharter:public-charter else $wcharter:charter</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:idno</xrx:name>
      <xrx:expression>$wcharter:charter//cei:body/cei:idno/text()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:linked-fond-base-collection</xrx:name>
      <xrx:expression>charter:linked-fond-base-collection($wcharter:charter/root()/atom:entry)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:meta</xrx:name>
      <xrx:expression>
        if($wcharter:context = 'fond') then
          $wcharter:metadata-fond-collection//ead:ead//ead:c[@level='fonds']/ead:did
        else if($wcharter:context = 'collection') then         
          $wcharter:metadata-collection-collection//cei:cei       
        else
          $wcharter:linked-fond-base-collection//ead:ead//ead:c[@level='fonds']/ead:did
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:fond</xrx:name>
      <xrx:expression>
        if($wcharter:context = 'fond' or $wcharter:context = 'linked-fond') then
          $wcharter:meta//ead:unittitle/text() 
        else 
          ($wcharter:meta//cei:provenance/text(),$wcharter:meta//cei:titleStmt/cei:title/text())
      </xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$wcharter:archive</xrx:name>
      <xrx:expression>$wcharter:metadata-archive-collection//eag:autform/text()</xrx:expression>
    </xrx:variable>
  </xrx:variables>
  <xrx:init>
   <xrx:processor>
     <xrx:xformsflag>false</xrx:xformsflag>
   </xrx:processor>
  </xrx:init>
	<xrx:view>
	  <div class="inlinehead cat">
	    <a href="javascript:showHideDiv_neu('howToCite', '')">
	      <xrx:i18n>
	        <xrx:key>how-to-cite</xrx:key>
	        <xrx:default>How to cite</xrx:default>
	      </xrx:i18n>
	    </a>
	  </div>
	  <div id="howToCite" style="display:none">
	    <div class="p">
	      <p>
	        <span>{ for $archive in $wcharter:archive return concat($archive, ',&#160;') }{ $wcharter:fond }&#160;{ $wcharter:idno }, in: Monasterium.net, URL &lt;https://www.monasterium.net{ $wcharter:default-url }/charter&gt;, accessed { current-date() }</span>
	      </p>
	    </div>
	  </div>
	</xrx:view>
</xrx:widget>